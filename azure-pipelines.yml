---
variables:
  - name: Build.Number.Major
    value: 9
  - name: Build.Number.Minor
    value: 4
  - name: Build.Number.Sub
    value: 1
  - name: BuildNumber
    value: $(Build.BuildNumber)

name: $(Build.Number.Major).$(Build.Number.Minor).$(Build.Number.Sub).$(Rev:r)

trigger:
- develop
- test
- main

pool: Docker

steps:
- task: CmdLine@2
  displayName: "Login"
  inputs:
    script: |
      docker login funkysi1701.azurecr.io --username funkysi1701 --password $(acrPassword)
- bash: |
    case "$(Build.SourceBranchName)" in
      "main")
        docker build -t blog-v2 .
        ;;
      "test" | "develop")
        docker build --build-arg BUILD_FUTURE_FLAG="--buildFuture" -t blog-v2 .
        ;;
    esac
    echo "##vso[task.setvariable variable=imageRepoName]blog-v2:$(Build.BuildNumber)-$(Build.SourceBranchName)"
  displayName: 'Set image repository name'
- task: CmdLine@2
  displayName: "Publish to ACR"
  condition: and(succeeded(), in(variables['Build.SourceBranch'], 'refs/heads/main', 'refs/heads/develop', 'refs/heads/test'))
  inputs:
    script: |
      docker tag blog-v2 funkysi1701.azurecr.io/funkysi1701/$(imageRepoName)
      docker push funkysi1701.azurecr.io/funkysi1701/$(imageRepoName)

- task: Kubernetes@1
  displayName: 'Kubernetes Login'
  inputs:
    connectionType: Kubernetes Service Connection
    kubernetesServiceEndpoint: kubernetes
    command: 'login'     
- script: |
    helm lint Helm/blog-v2 --namespace develop
    helm lint Helm/blog-v2 --namespace test
    helm lint Helm/blog-v2 --namespace main
- script: |
    helm upgrade --install blog-v2 ./Helm/blog-v2 --namespace develop --set image.tag=$(Build.BuildNumber)-develop
  condition: and(succeeded(), eq(variables['Build.SourceBranchName'], 'develop'))  
  displayName: 'helm upgrade blog-v2 Dev'
- script: |
    helm upgrade --install blog-v2 ./Helm/blog-v2 --namespace test --set image.tag=$(Build.BuildNumber)-test
  condition: and(succeeded(), eq(variables['Build.SourceBranchName'], 'test'))  
  displayName: 'helm upgrade blog-v2 Test'
- script: |
    helm upgrade --install blog-v2 ./Helm/blog-v2 --namespace main --set image.tag=$(Build.BuildNumber)-main
  condition: and(succeeded(), eq(variables['Build.SourceBranchName'], 'main'))  
  displayName: 'helm upgrade blog-v2 Main'